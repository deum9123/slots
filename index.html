<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>3-–ë–∞—Ä–∞–±–∞–Ω–Ω—ã–π –°–ª–æ—Ç</title>
<style>
  body { font-family: sans-serif; text-align: center; background: #222; color: #fff; }
  canvas { background: #444; border-radius: 10px; margin: 10px; }
  button { margin-top: 20px; padding: 10px 20px; font-size: 1.2em; cursor: pointer; border: none; border-radius: 5px; background: gold; color: #000; }
  .result { margin-top: 20px; font-size: 1.2em; }
</style>
</head>
<body>
<h1>üé∞ –°–ª–æ—Ç-–º–∞—à–∏–Ω–∞</h1>
<canvas id="slotCanvas" width="300" height="240"></canvas>
<button onclick="spin()">–ö—Ä—É—Ç–∏—Ç—å</button>
<div class="result" id="result"></div>

<script>
const symbols = ["üçí", "üçã", "üçä", "‚≠ê", "üíé"];
const payouts = {"üçí": 10, "üçã": 20, "üçä": 30, "‚≠ê": 50, "üíé": 100};
const canvas = document.getElementById("slotCanvas");
const ctx = canvas.getContext("2d");
const reelCount = 3;
const symbolHeight = 80;
const totalHeight = symbols.length * symbolHeight;
const START_DELAY = 30; // –∑–∞–¥–µ—Ä–∂–∫–∞ –º–µ–∂–¥—É —Å—Ç–∞—Ä—Ç–∞–º–∏

const bufferCanvas = document.createElement('canvas');
bufferCanvas.width = canvas.width;
bufferCanvas.height = canvas.height;
const bufferCtx = bufferCanvas.getContext('2d');

let reels = Array.from({ length: reelCount }, () => ({
  pos: 0,
  speed: 0,
  phase: "idle", // idle, pre-bounce, spinning, finalizing
  result: symbols[0],
  targetPos: 0,
  distanceLeft: 0,
  distanceTotal: 0,
  bounceLeft: 0,
  bounceSpeed: 0,
  finalSymbolNext: symbols[0],
  extraRotations: 3
}));

function normalizePos(pos) {
  pos = pos % totalHeight;
  if (pos < 0) pos += totalHeight;
  return pos;
}

function drawReels() {
  bufferCtx.clearRect(0, 0, bufferCanvas.width, bufferCanvas.height);
  bufferCtx.fillStyle = '#444';
  bufferCtx.fillRect(0, 0, bufferCanvas.width, bufferCanvas.height);

  reels.forEach((reel, i) => {
    bufferCtx.save();
    bufferCtx.beginPath();
    bufferCtx.rect(i * 100 + 10, 0, 80, 240);
    bufferCtx.clip();

    const basePos = normalizePos(reel.pos);

    for (let offset = -2; offset <= 2; offset++) {
      const symbolIndex = (Math.floor(basePos / symbolHeight) + offset + symbols.length) % symbols.length;
      let yPos = 120 + offset * symbolHeight - (basePos % symbolHeight);
      bufferCtx.font = "40px sans-serif";
      bufferCtx.textAlign = "center";
      bufferCtx.textBaseline = "middle";
      bufferCtx.fillText(symbols[symbolIndex], i * 100 + 50, yPos);
    }

    bufferCtx.restore();
  });

  ctx.clearRect(0, 0, canvas.width, canvas.height);
  ctx.drawImage(bufferCanvas, 0, 0);
}

function animate() {
  let spinning = false;

  reels.forEach((reel, i) => {
    if (reel.phase === "pre-bounce") {
      spinning = true;
      
      // –î–≤–∏–≥–∞–µ–º –≤–≤–µ—Ä—Ö —Å –∑–∞–º–µ–¥–ª–µ–Ω–∏–µ–º
      reel.pos += reel.bounceSpeed;
      reel.bounceLeft -= Math.abs(reel.bounceSpeed);
      
      // –ü–ª–∞–≤–Ω–æ–µ –∑–∞–º–µ–¥–ª–µ–Ω–∏–µ
      reel.bounceSpeed *= 0.85;

      if (Math.abs(reel.bounceSpeed) < 0.5 || reel.bounceLeft <= 0) {
        // –ü–µ—Ä–µ—Ö–æ–¥ –≤ —Ñ–∞–∑—É –≤—Ä–∞—â–µ–Ω–∏—è
        reel.phase = "spinning";
        reel.speed = -15;
        // –ü–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º —Ç–æ—á–Ω–æ–µ —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ —Å —É—á–µ—Ç–æ–º bounce
        const distanceToTarget = (reel.pos - reel.targetPos + totalHeight) % totalHeight;
        reel.distanceLeft = totalHeight * reel.extraRotations + distanceToTarget;
      }
    }
    else if (reel.phase === "spinning") {
      spinning = true;
      
      // –û—Å–Ω–æ–≤–Ω–æ–µ –≤—Ä–∞—â–µ–Ω–∏–µ
      reel.pos += reel.speed;
      reel.distanceLeft -= Math.abs(reel.speed);

      // –ù–∞—á–∏–Ω–∞–µ–º –∑–∞–º–µ–¥–ª—è—Ç—å—Å—è, –∫–æ–≥–¥–∞ –æ—Å—Ç–∞–ª–æ—Å—å –º–∞–ª–æ –¥–æ –æ—Å—Ç–∞–Ω–æ–≤–∫–∏
      if (reel.distanceLeft <= symbolHeight * 3) {
        reel.speed *= 0.96;
      }

      // –ü–µ—Ä–µ—Ö–æ–¥ –≤ —Ñ–∞–∑—É —Ç–æ—á–Ω–æ–π –æ—Å—Ç–∞–Ω–æ–≤–∫–∏
      if (reel.distanceLeft <= 0.5) {
        reel.phase = "finalizing";
      }
    }
    else if (reel.phase === "finalizing") {
      spinning = true;
      // –¢–æ—á–Ω–∞—è –ø–æ–¥–≥–æ–Ω–∫–∞ –∫ –Ω—É–∂–Ω–æ–π –ø–æ–∑–∏—Ü–∏–∏
      const distance = (reel.targetPos - reel.pos + totalHeight) % totalHeight;
      if (distance > 2) {
        reel.pos -= 2;
      } else if (distance < -2) {
        reel.pos += 2;
      } else {
        reel.pos = reel.targetPos;
        reel.phase = "idle";
        reel.speed = 0;
      }
    }
  });

  drawReels();

  if (spinning) {
    requestAnimationFrame(animate);
  } else {
    checkWin();
  }
}

function startReelWithDelay(index, finalSymbol, extraRotations, delay) {
  setTimeout(() => {
    const reel = reels[index];
    reel.extraRotations = extraRotations;

    const startIndex = symbols.indexOf(reel.result);
    reel.pos = startIndex * symbolHeight;
    reel.result = finalSymbol;
    reel.finalSymbolNext = finalSymbol;
    reel.targetPos = symbols.indexOf(finalSymbol) * symbolHeight;

    // –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º —Ç–æ—á–Ω–æ–µ —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ –¥–æ —Ü–µ–ª–∏
    const distanceToTarget = (reel.pos - reel.targetPos + totalHeight) % totalHeight;
    
    // –ì–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ–º, —á—Ç–æ —ç—Ç–æ—Ç –±–∞—Ä–∞–±–∞–Ω –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è –ø–æ—Å–ª–µ –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ
    if (index > 0) {
      const prevReel = reels[index - 1];
      const minDistance = prevReel.distanceLeft + symbolHeight * 3; // –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –æ—Ç—Å—Ç—É–ø
      
      // –ï—Å–ª–∏ —Ç–µ–∫—É—â–∞—è –¥–∏—Å—Ç–∞–Ω—Ü–∏—è –º–µ–Ω—å—à–µ –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–π, –¥–æ–±–∞–≤–ª—è–µ–º –ø–æ–ª–Ω—ã–µ –æ–±–æ—Ä–æ—Ç—ã
      let totalDistance = totalHeight * extraRotations + distanceToTarget + symbolHeight; // + bounce
      while (totalDistance <= minDistance) {
        extraRotations++;
        totalDistance += totalHeight;
      }
      
      reel.distanceTotal = totalDistance;
      reel.extraRotations = extraRotations;
    } else {
      reel.distanceTotal = totalHeight * extraRotations + distanceToTarget + symbolHeight;
    }
    
    reel.distanceLeft = reel.distanceTotal;

    // –ù–∞—Å—Ç—Ä–æ–π–∫–∏ bounce
    reel.bounceLeft = symbolHeight;
    reel.bounceSpeed = 10; // –Ω–∞—á–∞–ª—å–Ω–∞—è —Å–∫–æ—Ä–æ—Å—Ç—å –≤–≤–µ—Ä—Ö
    reel.phase = "pre-bounce";

    // –ó–∞–ø—É—Å–∫–∞–µ–º –∞–Ω–∏–º–∞—Ü–∏—é, –µ—Å–ª–∏ –æ–Ω–∞ –µ—â–µ –Ω–µ –∏–¥–µ—Ç
    if (index === 0) {
      requestAnimationFrame(animate);
    }
  }, delay);
}

function spin() {
  document.getElementById("result").textContent = "";
  const finalResults = ["‚≠ê", "üçã", "üçí"];

  reels.forEach((r, i) => {
    r.phase = "idle";
    r.speed = 0;
    r.finalSymbolNext = finalResults[i];
  });

  // –ó–∞–ø—É—Å–∫–∞–µ–º –∫–∞–∂–¥—ã–π –±–∞—Ä–∞–±–∞–Ω —Å –∑–∞–¥–µ—Ä–∂–∫–æ–π 0.5 —Å–µ–∫—É–Ω–¥—ã
  for (let i = 0; i < reelCount; i++) {
    startReelWithDelay(i, finalResults[i], 3, i * START_DELAY);
  }
}

function checkWin() {
  if (reels[0].result && reels[0].result === reels[1].result && reels[1].result === reels[2].result) {
    document.getElementById("result").textContent = `–í—ã –≤—ã–∏–≥—Ä–∞–ª–∏ ${payouts[reels[0].result]} –º–æ–Ω–µ—Ç!`;
  } else {
    document.getElementById("result").textContent = "–ù–µ—Ç –≤—ã–∏–≥—Ä—ã—à–∞";
  }
}

drawReels();
</script>
</body>
</html>